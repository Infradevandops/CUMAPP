name: Visual Regression Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  visual-regression:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for better comparisons

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright browsers
      run: npx playwright install --with-deps

    - name: Build Storybook
      run: npm run build-storybook

    - name: Run visual regression tests
      run: npm run test:visual
      continue-on-error: true  # Continue even if tests fail for baseline creation

    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: visual-test-results
        path: |
          test-results/
          playwright-report/
          coverage/
          screenshots/

    - name: Comment on PR with results
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      with:
        script: |
          const fs = require('fs');
          const path = require('path');

          // Read test results
          const resultsPath = path.join(process.cwd(), 'test-results', 'results.json');
          let results = { passed: 0, failed: 0, total: 0 };

          if (fs.existsSync(resultsPath)) {
            results = JSON.parse(fs.readFileSync(resultsPath, 'utf8'));
          }

          // Create comment
          const comment = `
          ## 🎨 Visual Regression Test Results

          **Tests Run:** ${results.total || 0}
          **Passed:** ${results.passed || 0} ✅
          **Failed:** ${results.failed || 0} ❌

          ${results.failed > 0 ? '### ⚠️ Visual Changes Detected' : '### ✅ No Visual Changes'}

          ${results.failed > 0 ? `
          Visual differences were found in the following components:
          - Component changes require review
          - Check the uploaded artifacts for detailed screenshots
          - Update baselines if changes are intentional
          ` : 'All components match their visual baselines.'}

          ---
          *View detailed test results in the "Artifacts" section above*
          `;

          // Post or update comment
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });

          const existingComment = comments.find(c =>
            c.body.includes('Visual Regression Test Results')
          );

          if (existingComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: existingComment.id,
              body: comment
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
          }

  accessibility-testing:
    runs-on: ubuntu-latest
    needs: visual-regression

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run accessibility tests
      run: npm run test:a11y
      continue-on-error: true

    - name: Upload accessibility reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: accessibility-reports
        path: |
          accessibility-report/
          axe-reports/

  performance-testing:
    runs-on: ubuntu-latest
    needs: visual-regression

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run performance tests
      run: npm run test:performance

    - name: Upload performance reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: performance-reports
        path: |
          performance-report/
          lighthouse-report/

  update-baselines:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: [visual-regression, accessibility-testing, performance-testing]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Update visual baselines
      run: |
        echo "Updating visual regression baselines..."
        # In a real implementation, this would update the baseline images
        # For now, we'll just log the action
        echo "Baselines updated for commit: $(git rev-parse HEAD)"

    - name: Commit baseline updates
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        git add -A
        git commit -m "chore: update visual regression baselines [skip ci]" || echo "No changes to commit"

        git push