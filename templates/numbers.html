<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phone Numbers - CumApp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <nav class="bg-blue-600 text-white shadow-md">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-3">
                <a class="text-xl font-bold" href="/dashboard">
                    <i class="fas fa-sms mr-2"></i>CumApp
                </a>
                <div class="flex items-center space-x-4">
                    <a class="px-3 py-2 rounded-md hover:bg-blue-700" href="/dashboard">Dashboard</a>
                    <a class="px-3 py-2 rounded-md hover:bg-blue-700" href="/services">Services</a>
                    <a class="px-3 py-2 rounded-md hover:bg-blue-700" href="#" onclick="logout()">Logout</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto mt-4 px-4">
        <div class="flex flex-wrap -mx-2">
            <div class="w-full px-2">
                <h2 class="text-2xl font-bold mb-2"><i class="fas fa-phone mr-2"></i>Phone Numbers</h2>
                <p class="text-gray-500 mb-4">Purchase temporary phone numbers for verification</p>
            </div>
        </div>

        <!-- Filters -->
        <div class="flex flex-wrap -mx-2 mb-4">
            <div class="w-full md:w-1/4 px-2 mb-4 md:mb-0">
                <select class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" id="countryFilter">
                    <option value="">All Countries</option>
                    <option value="US">ðŸ‡ºðŸ‡¸ United States</option>
                    <option value="UK">ðŸ‡¬ðŸ‡§ United Kingdom</option>
                    <option value="CA">ðŸ‡¨ðŸ‡¦ Canada</option>
                    <option value="DE">ðŸ‡©ðŸ‡ª Germany</option>
                    <option value="FR">ðŸ‡«ðŸ‡· France</option>
                    <option value="AU">ðŸ‡¦ðŸ‡º Australia</option>
                    <option value="IN">ðŸ‡®ðŸ‡³ India</option>
                    <option value="BR">ðŸ‡§ðŸ‡· Brazil</option>
                </select>
            </div>
            <div class="w-full md:w-1/4 px-2 mb-4 md:mb-0">
                <select class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" id="serviceFilter">
                    <option value="">All Services</option>
                    <option value="whatsapp">WhatsApp</option>
                    <option value="google">Google</option>
                    <option value="facebook">Facebook</option>
                    <option value="telegram">Telegram</option>
                </select>
            </div>
            <div class="w-full md:w-1/4 px-2 mb-4 md:mb-0">
                <select class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" id="priceFilter">
                    <option value="">All Prices</option>
                    <option value="low">$0.10 - $0.50</option>
                    <option value="mid">$0.50 - $1.00</option>
                    <option value="high">$1.00+</option>
                </select>
            </div>
            <div class="w-full md:w-1/4 px-2">
                <button class="w-full px-4 py-2 border border-blue-500 text-blue-500 rounded-md hover:bg-blue-500 hover:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" onclick="refreshNumbers()">
                    <i class="fas fa-sync mr-2"></i>Refresh
                </button>
            </div>
        </div>

        <!-- Available Numbers -->
        <div class="flex flex-wrap -mx-2 mb-4">
            <div class="w-full px-2">
                <div class="bg-white rounded-lg shadow-md">
                    <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                        <h5 class="text-xl font-bold mb-0">Available Numbers</h5>
                        <span class="px-2 py-1 rounded-full bg-green-500 text-white text-xs font-bold" id="availableCount">Loading...</span>
                    </div>
                    <div class="p-4">
                        <div id="availableNumbers">
                            <div class="text-center py-4">
                                <div class="animate-spin h-8 w-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto"></div>
                                <p class="mt-2">Loading available numbers...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- My Numbers -->
        <div class="flex flex-wrap -mx-2">
            <div class="w-full px-2">
                <div class="bg-white rounded-lg shadow-md">
                    <div class="p-4 border-b border-gray-200">
                        <h5 class="text-xl font-bold mb-0">My Numbers</h5>
                    </div>
                    <div class="p-4">
                        <div id="myNumbers">
                            <div class="text-center text-gray-500 py-4">
                                <i class="fas fa-phone-slash text-3xl mb-3"></i>
                                <p>No numbers purchased yet</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Purchase Modal -->
    <div id="purchaseModal" class="fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-md">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <h5 class="text-xl font-bold">Purchase Number</h5>
                <button type="button" class="text-gray-500 hover:text-gray-800" onclick="closeModal('purchaseModal')">&times;</button>
            </div>
            <div class="p-4">
                <div class="text-center mb-3">
                    <h4 class="text-xl font-bold" id="purchaseNumber"></h4>
                    <p class="text-gray-500" id="purchaseCountry"></p>
                </div>
                <div class="flex justify-between mb-3">
                    <div>
                        <strong>Duration:</strong> <span id="purchaseDuration">30 minutes</span>
                    </div>
                    <div>
                        <strong>Cost:</strong> <span id="purchaseCost">$0.50</span>
                    </div>
                </div>
                <div>
                    <strong>Supported Services:</strong>
                    <div id="supportedServices" class="mt-2 flex flex-wrap gap-2"></div>
                </div>
            </div>
            <div class="p-4 border-t border-gray-200 flex justify-end space-x-2">
                <button type="button" class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2" onclick="closeModal('purchaseModal')">Cancel</button>
                <button type="button" class="px-4 py-2 rounded-md bg-blue-500 hover:bg-blue-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" onclick="confirmPurchase()">
                    <i class="fas fa-shopping-cart mr-2"></i>Purchase
                </button>
            </div>
        </div>
    </div>

    <script>
        const mockNumbers = [
            {id: 1, number: '+1234567890', country: 'US', cost: 0.50, services: ['whatsapp', 'google', 'facebook']},
            {id: 2, number: '+1234567891', country: 'US', cost: 0.45, services: ['telegram', 'google']},
            {id: 3, number: '+4412345678', country: 'UK', cost: 0.60, services: ['whatsapp', 'facebook']},
            {id: 4, number: '+4912345678', country: 'DE', cost: 0.55, services: ['google', 'telegram']},
            {id: 5, number: '+33123456789', country: 'FR', cost: 0.65, services: ['whatsapp', 'google']},
            {id: 6, number: '+61123456789', country: 'AU', cost: 0.70, services: ['facebook', 'telegram']}
        ];

        const myNumbers = [];
        let selectedNumber = null;

        function renderAvailableNumbers(numbers = mockNumbers) {
            const container = document.getElementById('availableNumbers');
            document.getElementById('availableCount').textContent = numbers.length;

            if (numbers.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <i class="fas fa-search text-3xl mb-3"></i>
                        <p>No numbers available with current filters</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = numbers.map(num => `
                <div class="flex border-b border-gray-200 py-3 items-center">
                    <div class="w-1/4">
                        <strong class="block">${num.number}</strong>
                        <small class="text-gray-500">${getCountryName(num.country)}</small>
                    </div>
                    <div class="w-1/4">
                        <span class="px-2 py-1 rounded-full bg-green-500 text-white text-xs font-bold">${num.cost}</span>
                    </div>
                    <div class="w-1/3 flex flex-wrap gap-1">
                        ${num.services.map(s => `<span class="px-2 py-1 rounded-full bg-blue-500 text-white text-xs font-bold">${s}</span>`).join('')}
                    </div>
                    <div class="w-1/6 text-right">
                        <button class="px-3 py-1 text-sm bg-blue-500 hover:bg-blue-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" onclick="showPurchaseModal(${num.id})">
                            Buy
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function renderMyNumbers() {
            const container = document.getElementById('myNumbers');
            
            if (myNumbers.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <i class="fas fa-phone-slash text-3xl mb-3"></i>
                        <p>No numbers purchased yet</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = myNumbers.map(num => `
                <div class="flex border-b border-gray-200 py-3 items-center">
                    <div class="w-1/4">
                        <strong class="block">${num.number}</strong>
                        <small class="text-gray-500">${getCountryName(num.country)}</small>
                    </div>
                    <div class="w-1/4">
                        <span class="px-2 py-1 rounded-full text-white text-xs font-bold ${num.status === 'active' ? 'bg-green-500' : 'bg-yellow-500'}">${num.status}</span>
                    </div>
                    <div class="w-1/4">
                        <small>Expires: ${num.expires}</small>
                    </div>
                    <div class="w-1/4 text-right">
                        <button class="px-3 py-1 text-sm border border-blue-500 text-blue-500 rounded-md hover:bg-blue-500 hover:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" onclick="extendNumber(${num.id})">
                            Extend
                        </button>
                        <button class="px-3 py-1 text-sm border border-red-500 text-red-500 rounded-md hover:bg-red-500 hover:text-white rounded-md ml-1 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2" onclick="releaseNumber(${num.id})">
                            Release
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function showPurchaseModal(numberId) {
            const number = mockNumbers.find(n => n.id === numberId);
            if (!number) return;

            selectedNumber = number;
            document.getElementById('purchaseNumber').textContent = number.number;
            document.getElementById('purchaseCountry').textContent = getCountryName(number.country);
            document.getElementById('purchaseCost').textContent = `$${number.cost}`;
            
            const servicesHtml = number.services.map(s => 
                `<span class="px-2 py-1 rounded-full bg-blue-500 text-white text-xs font-bold">${s}</span>`
            ).join('');
            document.getElementById('supportedServices').innerHTML = servicesHtml;

            document.getElementById('purchaseModal').classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        async function confirmPurchase() {
            if (!selectedNumber) return;

            try {
                const response = await fetch('/api/numbers/purchase', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        number_id: selectedNumber.id,
                        duration: 30
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Add to my numbers
                    myNumbers.push({
                        id: selectedNumber.id,
                        number: selectedNumber.number,
                        country: selectedNumber.country,
                        status: 'active',
                        expires: new Date(Date.now() + 30*60*1000).toLocaleString()
                    });

                    // Remove from available
                    const index = mockNumbers.findIndex(n => n.id === selectedNumber.id);
                    if (index > -1) mockNumbers.splice(index, 1);

                    renderAvailableNumbers();
                    renderMyNumbers();
                    
                    closeModal('purchaseModal');
                    alert('Number purchased successfully!');
                } else {
                    alert('Purchase failed. Please try again.');
                }
            } catch (error) {
                alert('Network error. Please try again.');
            }
        }

        function extendNumber(numberId) {
            const number = myNumbers.find(n => n.id === numberId);
            if (number) {
                number.expires = new Date(Date.now() + 30*60*1000).toLocaleString();
                renderMyNumbers();
                alert('Number extended for 30 minutes');
            }
        }

        function releaseNumber(numberId) {
            const index = myNumbers.findIndex(n => n.id === numberId);
            if (index > -1) {
                const number = myNumbers[index];
                myNumbers.splice(index, 1);
                
                // Add back to available
                mockNumbers.push({
                    id: number.id,
                    number: number.number,
                    country: number.country,
                    cost: 0.50,
                    services: ['whatsapp', 'google']
                });
                
                renderAvailableNumbers();
                renderMyNumbers();
                alert('Number released');
            }
        }

        function getCountryName(code) {
            const countries = {
                'US': 'ðŸ‡ºðŸ‡¸ United States',
                'UK': 'ðŸ‡¬ðŸ‡§ United Kingdom',
                'CA': 'ðŸ‡¨ðŸ‡¦ Canada',
                'DE': 'ðŸ‡©ðŸ‡ª Germany',
                'FR': 'ðŸ‡«ðŸ‡· France',
                'AU': 'ðŸ‡¦ðŸ‡º Australia',
                'IN': 'ðŸ‡®ðŸ‡³ India',
                'BR': 'ðŸ‡§ðŸ‡· Brazil'
            };
            return countries[code] || code;
        }

        function refreshNumbers() {
            document.getElementById('availableNumbers').innerHTML = `
                <div class="text-center py-4">
                    <div class="animate-spin h-8 w-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto"></div>
                    <p class="mt-2">Refreshing numbers...</p>
                </div>
            `;
            
            setTimeout(() => {
                renderAvailableNumbers();
            }, 1000);
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/login';
        }

        // Filters
        document.getElementById('countryFilter').addEventListener('change', applyFilters);
        document.getElementById('serviceFilter').addEventListener('change', applyFilters);
        document.getElementById('priceFilter').addEventListener('change', applyFilters);

        function applyFilters() {
            let filtered = [...mockNumbers];
            
            const country = document.getElementById('countryFilter').value;
            const service = document.getElementById('serviceFilter').value;
            const price = document.getElementById('priceFilter').value;

            if (country) filtered = filtered.filter(n => n.country === country);
            if (service) filtered = filtered.filter(n => n.services.includes(service));
            if (price) {
                if (price === 'low') filtered = filtered.filter(n => n.cost <= 0.50);
                else if (price === 'mid') filtered = filtered.filter(n => n.cost > 0.50 && n.cost <= 1.00);
                else if (price === 'high') filtered = filtered.filter(n => n.cost > 1.00);
            }

            renderAvailableNumbers(filtered);
        }

        // Check auth and load data
        if (!localStorage.getItem('token')) {
            window.location.href = '/login';
        }

        renderAvailableNumbers();
        renderMyNumbers();
    </script>
</body>
</html>