<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMSPROJ - Communication Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .chat-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .chat-body {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        .sidebar {
            width: 350px;
            background: white;
            border-right: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            background: #f8f9fa;
        }
        
        .conversations-list {
            flex: 1;
            overflow-y: auto;
        }
        
        .conversation-item {
            padding: 1rem;
            border-bottom: 1px solid #f1f3f4;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .conversation-item:hover {
            background-color: #f8f9fa;
        }
        
        .conversation-item.active {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        
        .conversation-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .conversation-preview {
            color: #6c757d;
            font-size: 0.875rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .conversation-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.25rem;
        }
        
        .conversation-time {
            font-size: 0.75rem;
            color: #6c757d;
        }
        
        .unread-badge {
            background: #dc3545;
            color: white;
            border-radius: 50%;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            min-width: 1.5rem;
            text-align: center;
        }
        
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }
        
        .chat-main-header {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            background: #f8f9fa;
        }
        
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: #f8f9fa;
        }
        
        .message {
            margin-bottom: 1rem;
            display: flex;
        }
        
        .message.sent {
            justify-content: flex-end;
        }
        
        .message.received {
            justify-content: flex-start;
        }
        
        .message-bubble {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            position: relative;
        }
        
        .message.sent .message-bubble {
            background: #007bff;
            color: white;
            border-bottom-right-radius: 0.25rem;
        }
        
        .message.received .message-bubble {
            background: white;
            color: #333;
            border: 1px solid #e9ecef;
            border-bottom-left-radius: 0.25rem;
        }
        
        .message-time {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 0.25rem;
        }
        
        .message-status {
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }
        
        .typing-indicator {
            padding: 0.5rem 1rem;
            font-style: italic;
            color: #6c757d;
            font-size: 0.875rem;
        }
        
        .message-input-container {
            padding: 1rem;
            border-top: 1px solid #e9ecef;
            background: white;
        }
        
        .message-input {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }
        
        .message-input textarea {
            flex: 1;
            border: 1px solid #e9ecef;
            border-radius: 1.5rem;
            padding: 0.75rem 1rem;
            resize: none;
            max-height: 120px;
        }
        
        .send-button {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .send-button:hover {
            background: #0056b3;
        }
        
        .send-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .online-indicator {
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            display: inline-block;
            margin-left: 0.5rem;
        }
        
        .offline-indicator {
            width: 8px;
            height: 8px;
            background: #6c757d;
            border-radius: 50%;
            display: inline-block;
            margin-left: 0.5rem;
        }
        
        .connection-status {
            padding: 0.5rem;
            text-align: center;
            font-size: 0.875rem;
        }
        
        .connection-status.connected {
            background: #d4edda;
            color: #155724;
        }
        
        .connection-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .new-conversation-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
            cursor: pointer;
            z-index: 1000;
        }
        
        .new-conversation-btn:hover {
            background: #0056b3;
            transform: scale(1.05);
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: absolute;
                z-index: 100;
                height: 100%;
                transform: translateX(-100%);
                transition: transform 0.3s;
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .chat-main {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Header -->
        <div class="chat-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-0">
                        <i class="fas fa-comments me-2"></i>SMSPROJ Chat
                    </h4>
                    <small id="user-info">Loading...</small>
                </div>
                <div>
                    <button class="btn btn-light btn-sm me-2" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                    <button class="btn btn-light btn-sm" onclick="showSettings()">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Connection Status -->
        <div id="connection-status" class="connection-status disconnected">
            <i class="fas fa-wifi me-1"></i>Connecting...
        </div>
        
        <!-- Chat Body -->
        <div class="chat-body">
            <!-- Sidebar -->
            <div class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Conversations</h6>
                        <button class="btn btn-sm btn-outline-primary" onclick="showNewConversation()">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="mt-2">
                        <input type="text" class="form-control form-control-sm" 
                               placeholder="Search conversations..." id="search-input">
                    </div>
                </div>
                
                <div class="conversations-list" id="conversations-list">
                    <!-- Conversations will be loaded here -->
                </div>
            </div>
            
            <!-- Main Chat Area -->
            <div class="chat-main">
                <div class="chat-main-header" id="chat-header" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0" id="conversation-name">Select a conversation</h6>
                            <small class="text-muted" id="conversation-info"></small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary me-2" onclick="showConversationInfo()">
                                <i class="fas fa-info-circle"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="showConversationSettings()">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="messages-container" id="messages-container">
                    <div class="text-center text-muted mt-5">
                        <i class="fas fa-comments fa-3x mb-3"></i>
                        <h5>Welcome to SMSPROJ Chat</h5>
                        <p>Select a conversation to start messaging or create a new one</p>
                    </div>
                </div>
                
                <div class="typing-indicator" id="typing-indicator" style="display: none;">
                    <i class="fas fa-circle-notch fa-spin me-1"></i>
                    <span id="typing-text">Someone is typing...</span>
                </div>
                
                <div class="message-input-container" id="message-input-container" style="display: none;">
                    <div class="message-input">
                        <textarea id="message-input" placeholder="Type a message..." 
                                rows="1" onkeydown="handleKeyDown(event)" 
                                oninput="handleTyping()"></textarea>
                        <button class="send-button" id="send-button" onclick="sendMessage()" disabled>
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- New Conversation Button -->
    <button class="new-conversation-btn" onclick="showNewConversation()">
        <i class="fas fa-plus"></i>
    </button>
    
    <!-- Modals -->
    <!-- New Conversation Modal -->
    <div class="modal fade" id="newConversationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">New Conversation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Message Type</label>
                        <select class="form-select" id="message-type">
                            <option value="internal">Platform User</option>
                            <option value="sms">SMS to Phone Number</option>
                        </select>
                    </div>
                    <div class="mb-3" id="user-select-group">
                        <label class="form-label">Select User</label>
                        <select class="form-select" id="recipient-user">
                            <option value="">Choose a user...</option>
                        </select>
                    </div>
                    <div class="mb-3" id="phone-input-group" style="display: none;">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" id="recipient-phone" 
                               placeholder="+1234567890">
                    </div>
                    <div class="mb-3" id="from-number-group" style="display: none;">
                        <label class="form-label">From Number</label>
                        <select class="form-select" id="from-number">
                            <option value="">Choose your number...</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createConversation()">Start Conversation</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let ws = null;
        let currentUser = 'user_demo'; // Demo user ID
        let currentConversation = null;
        let conversations = [];
        let typingTimer = null;
        let isTyping = false;
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
        
        async function initializeApp() {
            // Set user info
            document.getElementById('user-info').textContent = `Logged in as: ${currentUser}`;
            
            // Connect WebSocket
            connectWebSocket();
            
            // Load conversations
            await loadConversations();
            
            // Load user numbers for SMS
            await loadUserNumbers();
            
            // Setup event listeners
            setupEventListeners();
        }
        
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/api/messaging/ws/${currentUser}`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                console.log('WebSocket connected');
                updateConnectionStatus(true);
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            ws.onclose = function() {
                console.log('WebSocket disconnected');
                updateConnectionStatus(false);
                
                // Reconnect after 3 seconds
                setTimeout(connectWebSocket, 3000);
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                updateConnectionStatus(false);
            };
        }
        
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connection-status');
            if (connected) {
                statusEl.className = 'connection-status connected';
                statusEl.innerHTML = '<i class="fas fa-wifi me-1"></i>Connected';
            } else {
                statusEl.className = 'connection-status disconnected';
                statusEl.innerHTML = '<i class="fas fa-wifi me-1"></i>Disconnected - Reconnecting...';
            }
        }
        
        function handleWebSocketMessage(data) {
            console.log('WebSocket message:', data);
            
            switch(data.type) {
                case 'new_message':
                    handleNewMessage(data.message);
                    break;
                case 'sms_sent':
                case 'sms_received':
                    handleNewMessage(data.message);
                    break;
                case 'typing_indicator':
                    handleTypingIndicator(data);
                    break;
                case 'message_read':
                    handleMessageRead(data);
                    break;
                case 'user_status':
                    handleUserStatus(data);
                    break;
            }
        }
        
        async function loadConversations() {
            try {
                const response = await fetch('/api/messaging/conversations', {
                    headers: {
                        'Authorization': `Bearer ${currentUser}`
                    }
                });
                
                if (response.ok) {
                    conversations = await response.json();
                    renderConversations();
                } else {
                    console.error('Failed to load conversations');
                }
            } catch (error) {
                console.error('Error loading conversations:', error);
            }
        }
        
        function renderConversations() {
            const container = document.getElementById('conversations-list');
            
            if (conversations.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted p-4">
                        <i class="fas fa-inbox fa-2x mb-2"></i>
                        <p>No conversations yet</p>
                        <button class="btn btn-primary btn-sm" onclick="showNewConversation()">
                            Start a conversation
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = conversations.map(conv => `
                <div class="conversation-item ${currentConversation?.id === conv.id ? 'active' : ''}" 
                     onclick="selectConversation('${conv.id}')">
                    <div class="conversation-name">${conv.name}</div>
                    <div class="conversation-preview">
                        ${conv.last_message ? conv.last_message.content : 'No messages yet'}
                    </div>
                    <div class="conversation-meta">
                        <span class="conversation-time">
                            ${conv.last_message ? formatTime(conv.last_message.created_at) : ''}
                        </span>
                        ${conv.unread_count > 0 ? `<span class="unread-badge">${conv.unread_count}</span>` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        async function selectConversation(conversationId) {
            const conversation = conversations.find(c => c.id === conversationId);
            if (!conversation) return;
            
            currentConversation = conversation;
            
            // Update UI
            document.getElementById('chat-header').style.display = 'block';
            document.getElementById('message-input-container').style.display = 'block';
            document.getElementById('conversation-name').textContent = conversation.name;
            
            let info = '';
            if (conversation.external_number) {
                info = `SMS: ${conversation.external_number}`;
            } else if (conversation.participants.length > 0) {
                info = `${conversation.participants.length} participant${conversation.participants.length > 1 ? 's' : ''}`;
            }
            document.getElementById('conversation-info').textContent = info;
            
            // Load messages
            await loadMessages(conversationId);
            
            // Update conversations list
            renderConversations();
            
            // Hide sidebar on mobile
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('show');
            }
        }
        
        async function loadMessages(conversationId) {
            try {
                const response = await fetch(`/api/messaging/conversations/${conversationId}/messages`, {
                    headers: {
                        'Authorization': `Bearer ${currentUser}`
                    }
                });
                
                if (response.ok) {
                    const messages = await response.json();
                    renderMessages(messages);
                } else {
                    console.error('Failed to load messages');
                }
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }
        
        function renderMessages(messages) {
            const container = document.getElementById('messages-container');
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted mt-5">
                        <i class="fas fa-comment fa-2x mb-2"></i>
                        <p>No messages yet. Start the conversation!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = messages.map(msg => {
                const isSent = msg.sender_id === currentUser;
                return `
                    <div class="message ${isSent ? 'sent' : 'received'}">
                        <div class="message-bubble">
                            <div>${msg.content}</div>
                            <div class="message-time">${formatTime(msg.created_at)}</div>
                            ${isSent ? `<div class="message-status">${getStatusIcon(msg.status)}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }
        
        function handleNewMessage(message) {
            // Update conversation in list
            const convIndex = conversations.findIndex(c => c.id === message.conversation_id);
            if (convIndex !== -1) {
                conversations[convIndex].last_message = message;
                conversations[convIndex].updated_at = message.created_at;
                
                // Move to top
                const conv = conversations.splice(convIndex, 1)[0];
                conversations.unshift(conv);
                
                renderConversations();
            }
            
            // If this is the current conversation, add message
            if (currentConversation && currentConversation.id === message.conversation_id) {
                const container = document.getElementById('messages-container');
                const isSent = message.sender_id === currentUser;
                
                const messageEl = document.createElement('div');
                messageEl.className = `message ${isSent ? 'sent' : 'received'}`;
                messageEl.innerHTML = `
                    <div class="message-bubble">
                        <div>${message.content}</div>
                        <div class="message-time">${formatTime(message.created_at)}</div>
                        ${isSent ? `<div class="message-status">${getStatusIcon(message.status)}</div>` : ''}
                    </div>
                `;
                
                container.appendChild(messageEl);
                container.scrollTop = container.scrollHeight;
            }
        }
        
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const content = input.value.trim();
            
            if (!content || !currentConversation) return;
            
            const sendButton = document.getElementById('send-button');
            sendButton.disabled = true;
            
            try {
                const payload = {
                    content: content
                };
                
                if (currentConversation.external_number) {
                    payload.phone_number = currentConversation.external_number;
                } else if (currentConversation.participants.length > 0) {
                    payload.recipient_id = currentConversation.participants[0].id;
                }
                
                const response = await fetch('/api/messaging/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentUser}`
                    },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    input.value = '';
                    adjustTextareaHeight(input);
                } else {
                    const error = await response.json();
                    alert('Failed to send message: ' + error.detail);
                }
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Failed to send message');
            } finally {
                sendButton.disabled = false;
            }
        }
        
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        function handleTyping() {
            const input = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            
            // Enable/disable send button
            sendButton.disabled = !input.value.trim();
            
            // Adjust textarea height
            adjustTextareaHeight(input);
            
            // Send typing indicator
            if (currentConversation && ws && ws.readyState === WebSocket.OPEN) {
                if (!isTyping) {
                    isTyping = true;
                    ws.send(JSON.stringify({
                        type: 'typing',
                        conversation_id: currentConversation.id,
                        is_typing: true
                    }));
                }
                
                // Clear existing timer
                clearTimeout(typingTimer);
                
                // Set timer to stop typing indicator
                typingTimer = setTimeout(() => {
                    if (isTyping) {
                        isTyping = false;
                        ws.send(JSON.stringify({
                            type: 'typing',
                            conversation_id: currentConversation.id,
                            is_typing: false
                        }));
                    }
                }, 1000);
            }
        }
        
        function adjustTextareaHeight(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }
        
        function handleTypingIndicator(data) {
            if (currentConversation && data.conversation_id === currentConversation.id) {
                const indicator = document.getElementById('typing-indicator');
                const text = document.getElementById('typing-text');
                
                if (data.typing_users && data.typing_users.length > 0) {
                    const typingUsers = data.typing_users.filter(uid => uid !== currentUser);
                    if (typingUsers.length > 0) {
                        text.textContent = `${typingUsers.length === 1 ? 'Someone is' : 'People are'} typing...`;
                        indicator.style.display = 'block';
                    } else {
                        indicator.style.display = 'none';
                    }
                } else {
                    indicator.style.display = 'none';
                }
            }
        }
        
        async function showNewConversation() {
            // Load available users (this would come from an API)
            const userSelect = document.getElementById('recipient-user');
            userSelect.innerHTML = '<option value="">Choose a user...</option>';
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('newConversationModal'));
            modal.show();
        }
        
        async function loadUserNumbers() {
            try {
                const response = await fetch('/api/messaging/numbers', {
                    headers: {
                        'Authorization': `Bearer ${currentUser}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const select = document.getElementById('from-number');
                    select.innerHTML = '<option value="">Choose your number...</option>';
                    
                    data.numbers.forEach(num => {
                        select.innerHTML += `<option value="${num.id}">${num.phone_number} (${num.country_code})</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading user numbers:', error);
            }
        }
        
        function setupEventListeners() {
            // Message type change
            document.getElementById('message-type').addEventListener('change', function() {
                const userGroup = document.getElementById('user-select-group');
                const phoneGroup = document.getElementById('phone-input-group');
                const fromGroup = document.getElementById('from-number-group');
                
                if (this.value === 'sms') {
                    userGroup.style.display = 'none';
                    phoneGroup.style.display = 'block';
                    fromGroup.style.display = 'block';
                } else {
                    userGroup.style.display = 'block';
                    phoneGroup.style.display = 'none';
                    fromGroup.style.display = 'none';
                }
            });
        }
        
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('show');
        }
        
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) { // Less than 1 minute
                return 'Just now';
            } else if (diff < 3600000) { // Less than 1 hour
                return Math.floor(diff / 60000) + 'm';
            } else if (diff < 86400000) { // Less than 1 day
                return Math.floor(diff / 3600000) + 'h';
            } else {
                return date.toLocaleDateString();
            }
        }
        
        function getStatusIcon(status) {
            switch(status) {
                case 'sent': return '<i class="fas fa-check"></i>';
                case 'delivered': return '<i class="fas fa-check-double"></i>';
                case 'read': return '<i class="fas fa-check-double text-primary"></i>';
                case 'failed': return '<i class="fas fa-exclamation-triangle text-danger"></i>';
                default: return '<i class="fas fa-clock"></i>';
            }
        }
        
        // Placeholder functions
        function createConversation() {
            console.log('Create conversation');
        }
        
        function showSettings() {
            console.log('Show settings');
        }
        
        function showConversationInfo() {
            console.log('Show conversation info');
        }
        
        function showConversationSettings() {
            console.log('Show conversation settings');
        }
    </script>
</body>
</html>