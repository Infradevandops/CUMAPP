<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>International Routing - CumApp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <!-- Enhanced Navigation -->
    <nav class="bg-blue-600 text-white shadow-md">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-3">
                <a class="text-xl font-bold" href="/dashboard">
                    <i class="fas fa-sms mr-2"></i>CumApp
                </a>
                <div class="hidden md:flex items-center space-x-4">
                    <a class="px-3 py-2 rounded-md hover:bg-blue-700" href="/dashboard"><i class="fas fa-home mr-1"></i>Dashboard</a>
                    <a class="px-3 py-2 rounded-md hover:bg-blue-700" href="/services"><i class="fas fa-list mr-1"></i>Services</a>
                    <a class="px-3 py-2 rounded-md hover:bg-blue-700" href="/verifications"><i class="fas fa-check-circle mr-1"></i>Verifications</a>
                    <a class="px-3 py-2 rounded-md hover:bg-blue-700" href="/numbers"><i class="fas fa-phone mr-1"></i>Numbers</a>
                    <a class="px-3 py-2 rounded-md hover:bg-blue-700" href="/communication"><i class="fas fa-comments mr-1"></i>Communication</a>
                    <a class="px-3 py-2 rounded-md bg-blue-700" href="/routing"><i class="fas fa-globe mr-1"></i>International</a>
                    <a class="px-3 py-2 rounded-md hover:bg-blue-700 relative" href="/inbox">
                        <i class="fas fa-inbox mr-1"></i>Inbox
                        <span class="absolute top-0 right-0 -mt-1 -mr-1 px-2 py-1 bg-red-500 text-white rounded-full text-xs" id="inboxBadge" style="display: none;">0</span>
                    </a>
                </div>
                <div class="hidden md:flex items-center">
                    <div class="relative">
                        <button class="px-3 py-2 rounded-md hover:bg-blue-700 flex items-center" onclick="toggleDropdown()"><i class="fas fa-user mr-1"></i><span id="userEmail">User</span><i class="fas fa-caret-down ml-2"></i></button>
                        <div id="dropdownMenu" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-20 hidden">
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" onclick="logout()"><i class="fas fa-sign-out-alt mr-2"></i>Logout</a>
                        </div>
                    </div>
                </div>
                <div class="md:hidden">
                    <button onclick="toggleMobileMenu()"><i class="fas fa-bars"></i></button>
                </div>
            </div>
            <div id="mobileMenu" class="hidden md:hidden">
                <a class="block px-3 py-2 rounded-md hover:bg-blue-700" href="/dashboard"><i class="fas fa-home mr-1"></i>Dashboard</a>
                <a class="block px-3 py-2 rounded-md hover:bg-blue-700" href="/services"><i class="fas fa-list mr-1"></i>Services</a>
                <a class="block px-3 py-2 rounded-md hover:bg-blue-700" href="/verifications"><i class="fas fa-check-circle mr-1"></i>Verifications</a>
                <a class="block px-3 py-2 rounded-md hover:bg-blue-700" href="/numbers"><i class="fas fa-phone mr-1"></i>Numbers</a>
                <a class="block px-3 py-2 rounded-md hover:bg-blue-700" href="/communication"><i class="fas fa-comments mr-1"></i>Communication</a>
                <a class="block px-3 py-2 rounded-md bg-blue-700" href="/routing"><i class="fas fa-globe mr-1"></i>International</a>
                <a class="block px-3 py-2 rounded-md hover:bg-blue-700 relative" href="/inbox">
                    <i class="fas fa-inbox mr-1"></i>Inbox
                    <span class="absolute top-0 left-0 ml-6 -mt-1 px-2 py-1 bg-red-500 text-white rounded-full text-xs" id="inboxBadgeMobile" style="display: none;">0</span>
                </a>
                <a href="#" class="block px-3 py-2 rounded-md hover:bg-blue-700" onclick="logout()"><i class="fas fa-sign-out-alt mr-2"></i>Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto mt-4 px-4">
        <!-- Page Header -->
        <div class="flex justify-between items-center mb-4">
            <div>
                <h2 class="text-2xl font-bold"><i class="fas fa-globe mr-2"></i>International SMS Routing</h2>
                <p class="text-gray-500">Optimize your international SMS costs with smart routing</p>
            </div>
            <div>
                <button class="px-4 py-2 rounded-md border border-blue-500 text-blue-500 mr-2" onclick="refreshRates()">
                    <i class="fas fa-sync-alt mr-1"></i>Refresh Rates
                </button>
                <button class="px-4 py-2 rounded-md bg-green-500 text-white" onclick="showBulkSendModal()">
                    <i class="fas fa-paper-plane mr-1"></i>Send SMS
                </button>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
            <div class="bg-blue-500 text-white rounded-lg shadow-md p-4 text-center">
                <i class="fas fa-globe fa-2x mb-2"></i>
                <h4 class="text-2xl font-bold">195</h4>
                <small>Countries Supported</small>
            </div>
            <div class="bg-green-500 text-white rounded-lg shadow-md p-4 text-center">
                <i class="fas fa-dollar-sign fa-2x mb-2"></i>
                <h4 class="text-2xl font-bold">35%</h4>
                <small>Average Savings</small>
            </div>
            <div class="bg-cyan-500 text-white rounded-lg shadow-md p-4 text-center">
                <i class="fas fa-route fa-2x mb-2"></i>
                <h4 class="text-2xl font-bold">3-5</h4>
                <small>Route Options</small>
            </div>
            <div class="bg-yellow-500 text-white rounded-lg shadow-md p-4 text-center">
                <i class="fas fa-clock fa-2x mb-2"></i>
                <h4 class="text-2xl font-bold">2-5s</h4>
                <small>Delivery Time</small>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex flex-wrap -mx-2">
            <!-- Country Selection -->
            <div class="w-full lg:w-1/3 px-2">
                <div class="bg-white rounded-lg shadow-md">
                    <div class="p-4 border-b">
                        <h5 class="font-bold mb-0"><i class="fas fa-map mr-2"></i>Select Destination Country</h5>
                    </div>
                    <div class="p-4">
                        <!-- Search -->
                        <div class="mb-3">
                            <input type="text" class="w-full px-3 py-2 border rounded-md" id="countrySearch" placeholder="Search countries..." onkeyup="filterCountries()">
                        </div>
                        
                        <!-- Popular Countries -->
                        <div class="mb-3">
                            <h6 class="text-gray-500">Popular Destinations</h6>
                            <div class="grid grid-cols-2 gap-2" id="popularCountries">
                                <!-- Popular countries will be loaded here -->
                            </div>
                        </div>
                        
                        <!-- All Countries -->
                        <div style="max-height: 400px; overflow-y: auto;">
                            <div id="allCountries">
                                <!-- All countries will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Routing Options -->
            <div class="w-full lg:w-2/3 px-2">
                <div class="bg-white rounded-lg shadow-md">
                    <div class="p-4 border-b">
                        <h5 class="font-bold mb-0"><i class="fas fa-route mr-2"></i>Smart Routing Options</h5>
                    </div>
                    <div class="p-4">
                        <div id="routingOptions">
                            <div class="text-center text-gray-500 py-20">
                                <i class="fas fa-map-marked-alt fa-3x mb-3"></i>
                                <p>Select a destination country to see routing options</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cost Comparison Section -->
        <div class="mt-4 hidden" id="costComparisonSection">
            <div class="bg-white rounded-lg shadow-md">
                <div class="p-4 border-b">
                    <h5 class="font-bold mb-0"><i class="fas fa-chart-line mr-2"></i>Cost Comparison & Recommendations</h5>
                </div>
                <div class="p-4">
                    <div id="costComparison">
                        <!-- Cost comparison will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let countries = [];
        let selectedCountry = null;
        let routingOptions = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadUserData();
            loadCountries();
            loadInboxBadge();
        });

        // Authentication check
        function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login';
                return false;
            }
            return true;
        }

        // Load user data
        async function loadUserData() {
            try {
                const demoUser = localStorage.getItem('user');
                if (demoUser) {
                    const user = JSON.parse(demoUser);
                    document.getElementById('userEmail').textContent = user.email;
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Load countries
        async function loadCountries() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/routing/countries', {
                    headers: token ? { 'Authorization': `Bearer ${token}` } : {}
                });
                
                if (response.ok) {
                    const countriesData = await response.json();
                    countries = countriesData.map(c => ({
                        code: c.code,
                        name: c.name,
                        flag: c.flag,
                        dialCode: c.dial_code,
                        cost: c.base_cost,
                        popular: c.popular
                    }));
                    
                    displayPopularCountries();
                    displayAllCountries();
                } else {
                    loadMockCountries();
                }
            } catch (error) {
                console.error('Error loading countries:', error);
                loadMockCountries();
            }
        }

        // Fallback mock countries
        function loadMockCountries() {
            countries = [
                { code: 'US', name: 'United States', flag: '🇺🇸', dialCode: '+1', cost: 0.01, popular: true },
                { code: 'GB', name: 'United Kingdom', flag: '🇬🇧', dialCode: '+44', cost: 0.02, popular: true },
                { code: 'CA', name: 'Canada', flag: '🇨🇦', dialCode: '+1', cost: 0.01, popular: true },
                { code: 'AU', name: 'Australia', flag: '🇦🇺', dialCode: '+61', cost: 0.03, popular: true },
                { code: 'DE', name: 'Germany', flag: '🇩🇪', dialCode: '+49', cost: 0.02, popular: true },
                { code: 'FR', name: 'France', flag: '🇫🇷', dialCode: '+33', cost: 0.02, popular: true },
                { code: 'JP', name: 'Japan', flag: '🇯🇵', dialCode: '+81', cost: 0.04, popular: false },
                { code: 'IN', name: 'India', flag: '🇮🇳', dialCode: '+91', cost: 0.02, popular: true }
            ];

            displayPopularCountries();
            displayAllCountries();
        }

        // Display popular countries
        function displayPopularCountries() {
            const container = document.getElementById('popularCountries');
            const popularCountries = countries.filter(c => c.popular);

            container.innerHTML = popularCountries.map(country => `
                <div class="bg-white rounded-lg shadow-md h-full text-center p-2 cursor-pointer transform hover:-translate-y-1 transition-transform duration-300 border-2 border-transparent hover:border-blue-500" onclick="selectCountry('${country.code}')">
                    <div class="text-2xl">${country.flag}</div>
                    <small class="font-bold">${country.name}</small>
                    <small class="text-gray-500">${country.dialCode}</small>
                </div>
            `).join('');
        }

        // Display all countries
        function displayAllCountries() {
            const container = document.getElementById('allCountries');

            container.innerHTML = countries.map(country => `
                <div class="bg-white rounded-lg shadow-md mb-2 p-3 cursor-pointer transform hover:-translate-y-1 transition-transform duration-300 border-2 border-transparent hover:border-blue-500" onclick="selectCountry('${country.code}')">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">${country.flag}</span>
                        <div class="flex-grow">
                            <div class="font-bold">${country.name}</div>
                            <small class="text-gray-500">${country.dialCode}</small>
                        </div>
                        <div class="text-right">
                            <small class="text-green-500 font-bold">$${country.cost.toFixed(3)}/SMS</small>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Filter countries
        function filterCountries() {
            const searchTerm = document.getElementById('countrySearch').value.toLowerCase();
            const filteredCountries = countries.filter(country => 
                country.name.toLowerCase().includes(searchTerm) || 
                country.dialCode.includes(searchTerm)
            );

            const container = document.getElementById('allCountries');
            container.innerHTML = filteredCountries.map(country => `
                <div class="bg-white rounded-lg shadow-md mb-2 p-3 cursor-pointer transform hover:-translate-y-1 transition-transform duration-300 border-2 border-transparent hover:border-blue-500" onclick="selectCountry('${country.code}')">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">${country.flag}</span>
                        <div class="flex-grow">
                            <div class="font-bold">${country.name}</div>
                            <small class="text-gray-500">${country.dialCode}</small>
                        </div>
                        <div class="text-right">
                            <small class="text-green-500 font-bold">$${country.cost.toFixed(3)}/SMS</small>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Select country
        function selectCountry(countryCode) {
            selectedCountry = countries.find(c => c.code === countryCode);
            
            // Update UI
            document.querySelectorAll('.country-card').forEach(card => {
                card.classList.remove('border-green-500', 'bg-green-50');
            });
            event.currentTarget.classList.add('border-green-500', 'bg-green-50');

            // Load routing options
            loadRoutingOptions(countryCode);
            
            // Show cost comparison
            document.getElementById('costComparisonSection').style.display = 'block';
            displayCostComparison();
        }

        // Load routing options
        async function loadRoutingOptions(countryCode) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/routing/recommendations/${countryCode}`, {
                    headers: token ? { 'Authorization': `Bearer ${token}` } : {}
                });
                
                if (response.ok) {
                    const data = await response.json();
                    routingOptions = [data.recommended_route, ...data.alternative_routes].map(route => ({
                        id: route.id,
                        type: route.type,
                        name: route.name,
                        description: route.description,
                        cost: route.cost_per_sms,
                        deliveryTime: route.delivery_time,
                        reliability: route.reliability,
                        recommended: route.recommended,
                        fromNumber: route.from_number,
                        savings: route.savings_percentage
                    }));
                    
                    displayRoutingOptions();
                } else {
                    loadMockRoutingOptions();
                }
            } catch (error) {
                console.error('Error loading routing options:', error);
                loadMockRoutingOptions();
            }
        }

        // Fallback mock routing options
        function loadMockRoutingOptions() {
            const mockRoutes = [
                {
                    id: 'direct',
                    type: 'direct',
                    name: 'Direct Route',
                    description: 'Send directly from your existing US number',
                    cost: 0.05,
                    deliveryTime: '2-5 seconds',
                    reliability: 95,
                    recommended: false,
                    fromNumber: '+1234567890',
                    savings: 0
                },
                {
                    id: 'local',
                    type: 'local',
                    name: 'Local Number Route',
                    description: `Purchase a local ${selectedCountry.name} number for better delivery`,
                    cost: selectedCountry.cost,
                    deliveryTime: '1-3 seconds',
                    reliability: 99,
                    recommended: true,
                    fromNumber: `${selectedCountry.dialCode}XXXXXXX`,
                    savings: 60
                }
            ];

            routingOptions = mockRoutes;
            displayRoutingOptions();
        }

        // Display routing options
        function displayRoutingOptions() {
            const container = document.getElementById('routingOptions');

            container.innerHTML = routingOptions.map(route => `
                <div class="border rounded-lg p-4 mb-2 transition-all duration-300 ${route.recommended ? 'border-green-500 bg-green-50' : 'border-gray-200'} hover:border-blue-500 hover:shadow-lg">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h6 class="font-bold mb-1">
                                ${route.name}
                                ${route.recommended ? '<span class="ml-2 px-2 py-1 bg-gradient-to-r from-green-400 to-green-600 text-white rounded-full text-xs font-bold">RECOMMENDED</span>' : ''}
                            </h6>
                            <p class="text-gray-500 mb-2">${route.description}</p>
                        </div>
                        <div class="text-right">
                            <h5 class="text-green-500 font-bold mb-0">$${route.cost.toFixed(3)}</h5>
                            <small class="text-gray-500">per SMS</small>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 text-center">
                        <div>
                            <small class="text-gray-500">Delivery Time</small>
                            <div class="font-bold">${route.deliveryTime}</div>
                        </div>
                        <div>
                            <small class="text-gray-500">Reliability</small>
                            <div class="font-bold">${route.reliability}%</div>
                        </div>
                        <div>
                            <small class="text-gray-500">Savings</small>
                            <div class="font-bold text-green-500">${route.recommended ? '60%' : '0%'}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Display cost comparison
        function displayCostComparison() {
            const container = document.getElementById('costComparison');
            const recommendedRoute = routingOptions.find(r => r.recommended);
            const directRoute = routingOptions.find(r => r.type === 'direct');

            if (!recommendedRoute || !directRoute) return;

            container.innerHTML = `
                <div class="flex flex-wrap -mx-2">
                    <div class="w-full md:w-1/2 px-2">
                        <div class="border rounded-lg p-3 bg-yellow-100 border-yellow-200">
                            <h6 class="font-bold"><i class="fas fa-lightbulb text-yellow-500 mr-2"></i>Smart Recommendation</h6>
                            <p class="mb-2">For sending to <strong>${selectedCountry.flag} ${selectedCountry.name}</strong>:</p>
                            <div class="flex justify-between">
                                <div>
                                    <strong>${recommendedRoute.name}</strong>
                                    <br><small class="text-gray-500">${recommendedRoute.description}</small>
                                </div>
                                <div class="text-right">
                                    <h5 class="text-green-500 font-bold mb-0">$${recommendedRoute.cost.toFixed(3)}</h5>
                                    <small class="text-green-500">Save 60%</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="w-full md:w-1/2 px-2">
                        <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg p-4">
                            <h6 class="text-center mb-3">Monthly Savings Estimate</h6>
                            <div class="flex text-center">
                                <div class="w-1/2 border-r border-blue-400">
                                    <h4 class="text-2xl font-bold">$${(directRoute.cost * 100).toFixed(2)}</h4>
                                    <small>Direct Route</small>
                                </div>
                                <div class="w-1/2">
                                    <h4 class="text-2xl font-bold">$${(recommendedRoute.cost * 100).toFixed(2)}</h4>
                                    <small>Recommended</small>
                                </div>
                            </div>
                            <hr class="border-blue-400 my-3">
                            <div class="text-center">
                                <h5 class="text-xl font-bold">Save $${((directRoute.cost - recommendedRoute.cost) * 100).toFixed(2)}/month</h5>
                                <small>Based on 100 SMS per month</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Load inbox badge
        async function loadInboxBadge() {
            try {
                const badge = document.getElementById('inboxBadge');
                badge.textContent = '3';
                badge.style.display = 'inline';
                const badgeMobile = document.getElementById('inboxBadgeMobile');
                badgeMobile.textContent = '3';
                badgeMobile.style.display = 'inline';
            } catch (error) {
                console.error('Error loading inbox badge:', error);
            }
        }

        // Show bulk send modal
        function showBulkSendModal() {
            alert('Bulk send feature coming soon!');
        }

        // Refresh rates
        function refreshRates() {
            alert('Exchange rates updated!');
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/login';
        }

        function toggleDropdown() {
            document.getElementById('dropdownMenu').classList.toggle('hidden');
        }

        function toggleMobileMenu() {
            document.getElementById('mobileMenu').classList.toggle('hidden');
        }
    </script>
</body>
</html>
