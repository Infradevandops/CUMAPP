<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>International Routing - CumApp</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .inbox-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 0.7rem;
        }
        .country-card {
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .country-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            border-color: #007bff;
        }
        .country-card.selected {
            border-color: #28a745;
            background-color: #f8fff9;
        }
        .cost-comparison {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
        }
        .savings-badge {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }
        .route-option {
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            transition: all 0.3s ease;
        }
        .route-option:hover {
            border-color: #007bff;
            box-shadow: 0 4px 12px rgba(0,123,255,0.15);
        }
        .route-option.recommended {
            border-color: #28a745;
            background-color: #f8fff9;
        }
        .nav-link.active {
            background-color: rgba(255,255,255,0.1) !important;
            border-radius: 5px;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Enhanced Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/dashboard">
                <i class="fas fa-sms me-2"></i>CumApp
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard">
                            <i class="fas fa-home me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/services">
                            <i class="fas fa-list me-1"></i>Services
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/verifications">
                            <i class="fas fa-check-circle me-1"></i>Verifications
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/numbers">
                            <i class="fas fa-phone me-1"></i>Numbers
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/communication">
                            <i class="fas fa-comments me-1"></i>Communication
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/routing">
                            <i class="fas fa-globe me-1"></i>International
                        </a>
                    </li>
                    <!-- Inbox Button -->
                    <li class="nav-item position-relative">
                        <a class="nav-link" href="/inbox">
                            <i class="fas fa-inbox me-1"></i>Inbox
                            <span class="badge bg-danger inbox-badge" id="inboxBadge" style="display: none;">0</span>
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user me-1"></i><span id="userEmail">User</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="logout()">
                                <i class="fas fa-sign-out-alt me-2"></i>Logout
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2><i class="fas fa-globe me-2"></i>International SMS Routing</h2>
                        <p class="text-muted">Optimize your international SMS costs with smart routing</p>
                    </div>
                    <div>
                        <button class="btn btn-outline-primary me-2" onclick="refreshRates()">
                            <i class="fas fa-sync-alt me-1"></i>Refresh Rates
                        </button>
                        <button class="btn btn-success" onclick="showBulkSendModal()">
                            <i class="fas fa-paper-plane me-1"></i>Send SMS
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-globe fa-2x mb-2"></i>
                        <h4>195</h4>
                        <small>Countries Supported</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-dollar-sign fa-2x mb-2"></i>
                        <h4>35%</h4>
                        <small>Average Savings</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-route fa-2x mb-2"></i>
                        <h4>3-5</h4>
                        <small>Route Options</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-clock fa-2x mb-2"></i>
                        <h4>2-5s</h4>
                        <small>Delivery Time</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row">
            <!-- Country Selection -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-map me-2"></i>Select Destination Country
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Search -->
                        <div class="mb-3">
                            <input type="text" class="form-control" id="countrySearch" placeholder="Search countries..." onkeyup="filterCountries()">
                        </div>
                        
                        <!-- Popular Countries -->
                        <div class="mb-3">
                            <h6 class="text-muted">Popular Destinations</h6>
                            <div class="row" id="popularCountries">
                                <!-- Popular countries will be loaded here -->
                            </div>
                        </div>
                        
                        <!-- All Countries -->
                        <div style="max-height: 400px; overflow-y: auto;">
                            <div id="allCountries">
                                <!-- All countries will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Routing Options -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-route me-2"></i>Smart Routing Options
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="routingOptions">
                            <div class="text-center text-muted py-5">
                                <i class="fas fa-map-marked-alt fa-3x mb-3"></i>
                                <p>Select a destination country to see routing options</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cost Comparison Section -->
        <div class="row mt-4" id="costComparisonSection" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>Cost Comparison & Recommendations
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="costComparison">
                            <!-- Cost comparison will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let countries = [];
        let selectedCountry = null;
        let routingOptions = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadUserData();
            loadCountries();
            loadInboxBadge();
        });

        // Authentication check
        function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login';
                return false;
            }
            return true;
        }

        // Load user data
        async function loadUserData() {
            try {
                const demoUser = localStorage.getItem('user');
                if (demoUser) {
                    const user = JSON.parse(demoUser);
                    document.getElementById('userEmail').textContent = user.email;
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Load countries
        async function loadCountries() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/routing/countries', {
                    headers: token ? { 'Authorization': `Bearer ${token}` } : {}
                });
                
                if (response.ok) {
                    const countriesData = await response.json();
                    countries = countriesData.map(c => ({
                        code: c.code,
                        name: c.name,
                        flag: c.flag,
                        dialCode: c.dial_code,
                        cost: c.base_cost,
                        popular: c.popular
                    }));
                    
                    displayPopularCountries();
                    displayAllCountries();
                } else {
                    loadMockCountries();
                }
            } catch (error) {
                console.error('Error loading countries:', error);
                loadMockCountries();
            }
        }

        // Fallback mock countries
        function loadMockCountries() {
            countries = [
                { code: 'US', name: 'United States', flag: 'ðŸ‡ºðŸ‡¸', dialCode: '+1', cost: 0.01, popular: true },
                { code: 'GB', name: 'United Kingdom', flag: 'ðŸ‡¬ðŸ‡§', dialCode: '+44', cost: 0.02, popular: true },
                { code: 'CA', name: 'Canada', flag: 'ðŸ‡¨ðŸ‡¦', dialCode: '+1', cost: 0.01, popular: true },
                { code: 'AU', name: 'Australia', flag: 'ðŸ‡¦ðŸ‡º', dialCode: '+61', cost: 0.03, popular: true },
                { code: 'DE', name: 'Germany', flag: 'ðŸ‡©ðŸ‡ª', dialCode: '+49', cost: 0.02, popular: true },
                { code: 'FR', name: 'France', flag: 'ðŸ‡«ðŸ‡·', dialCode: '+33', cost: 0.02, popular: true },
                { code: 'JP', name: 'Japan', flag: 'ðŸ‡¯ðŸ‡µ', dialCode: '+81', cost: 0.04, popular: false },
                { code: 'IN', name: 'India', flag: 'ðŸ‡®ðŸ‡³', dialCode: '+91', cost: 0.02, popular: true }
            ];

            displayPopularCountries();
            displayAllCountries();
        }

        // Display popular countries
        function displayPopularCountries() {
            const container = document.getElementById('popularCountries');
            const popularCountries = countries.filter(c => c.popular);

            container.innerHTML = popularCountries.map(country => `
                <div class="col-6 mb-2">
                    <div class="country-card card h-100 text-center p-2" onclick="selectCountry('${country.code}')">
                        <div style="font-size: 1.5rem;">${country.flag}</div>
                        <small class="fw-bold">${country.name}</small>
                        <small class="text-muted">${country.dialCode}</small>
                    </div>
                </div>
            `).join('');
        }

        // Display all countries
        function displayAllCountries() {
            const container = document.getElementById('allCountries');

            container.innerHTML = countries.map(country => `
                <div class="country-card card mb-2 p-3" onclick="selectCountry('${country.code}')">
                    <div class="d-flex align-items-center">
                        <span style="font-size: 1.5rem;" class="me-3">${country.flag}</span>
                        <div class="flex-grow-1">
                            <div class="fw-bold">${country.name}</div>
                            <small class="text-muted">${country.dialCode}</small>
                        </div>
                        <div class="text-end">
                            <small class="text-success fw-bold">$${country.cost.toFixed(3)}/SMS</small>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Filter countries
        function filterCountries() {
            const searchTerm = document.getElementById('countrySearch').value.toLowerCase();
            const filteredCountries = countries.filter(country => 
                country.name.toLowerCase().includes(searchTerm) || 
                country.dialCode.includes(searchTerm)
            );

            const container = document.getElementById('allCountries');
            container.innerHTML = filteredCountries.map(country => `
                <div class="country-card card mb-2 p-3" onclick="selectCountry('${country.code}')">
                    <div class="d-flex align-items-center">
                        <span style="font-size: 1.5rem;" class="me-3">${country.flag}</span>
                        <div class="flex-grow-1">
                            <div class="fw-bold">${country.name}</div>
                            <small class="text-muted">${country.dialCode}</small>
                        </div>
                        <div class="text-end">
                            <small class="text-success fw-bold">$${country.cost.toFixed(3)}/SMS</small>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Select country
        function selectCountry(countryCode) {
            selectedCountry = countries.find(c => c.code === countryCode);
            
            // Update UI
            document.querySelectorAll('.country-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            // Load routing options
            loadRoutingOptions(countryCode);
            
            // Show cost comparison
            document.getElementById('costComparisonSection').style.display = 'block';
            displayCostComparison();
        }

        // Load routing options
        async function loadRoutingOptions(countryCode) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/routing/recommendations/${countryCode}`, {
                    headers: token ? { 'Authorization': `Bearer ${token}` } : {}
                });
                
                if (response.ok) {
                    const data = await response.json();
                    routingOptions = [data.recommended_route, ...data.alternative_routes].map(route => ({
                        id: route.id,
                        type: route.type,
                        name: route.name,
                        description: route.description,
                        cost: route.cost_per_sms,
                        deliveryTime: route.delivery_time,
                        reliability: route.reliability,
                        recommended: route.recommended,
                        fromNumber: route.from_number,
                        savings: route.savings_percentage
                    }));
                    
                    displayRoutingOptions();
                } else {
                    loadMockRoutingOptions();
                }
            } catch (error) {
                console.error('Error loading routing options:', error);
                loadMockRoutingOptions();
            }
        }

        // Fallback mock routing options
        function loadMockRoutingOptions() {
            const mockRoutes = [
                {
                    id: 'direct',
                    type: 'direct',
                    name: 'Direct Route',
                    description: 'Send directly from your existing US number',
                    cost: 0.05,
                    deliveryTime: '2-5 seconds',
                    reliability: 95,
                    recommended: false,
                    fromNumber: '+1234567890',
                    savings: 0
                },
                {
                    id: 'local',
                    type: 'local',
                    name: 'Local Number Route',
                    description: `Purchase a local ${selectedCountry.name} number for better delivery`,
                    cost: selectedCountry.cost,
                    deliveryTime: '1-3 seconds',
                    reliability: 99,
                    recommended: true,
                    fromNumber: `${selectedCountry.dialCode}XXXXXXX`,
                    savings: 60
                }
            ];

            routingOptions = mockRoutes;
            displayRoutingOptions();
        }

        // Display routing options
        function displayRoutingOptions() {
            const container = document.getElementById('routingOptions');

            container.innerHTML = routingOptions.map(route => `
                <div class="route-option ${route.recommended ? 'recommended' : ''}">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <h6 class="mb-1">
                                ${route.name}
                                ${route.recommended ? '<span class="savings-badge ms-2">RECOMMENDED</span>' : ''}
                            </h6>
                            <p class="text-muted mb-2">${route.description}</p>
                        </div>
                        <div class="text-end">
                            <h5 class="text-success mb-0">$${route.cost.toFixed(3)}</h5>
                            <small class="text-muted">per SMS</small>
                        </div>
                    </div>
                    <div class="row text-center">
                        <div class="col-md-4">
                            <small class="text-muted">Delivery Time</small>
                            <div class="fw-bold">${route.deliveryTime}</div>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted">Reliability</small>
                            <div class="fw-bold">${route.reliability}%</div>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted">Savings</small>
                            <div class="fw-bold text-success">${route.recommended ? '60%' : '0%'}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Display cost comparison
        function displayCostComparison() {
            const container = document.getElementById('costComparison');
            const recommendedRoute = routingOptions.find(r => r.recommended);
            const directRoute = routingOptions.find(r => r.type === 'direct');

            if (!recommendedRoute || !directRoute) return;

            container.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="border rounded p-3" style="background-color: #fff8e1;">
                            <h6><i class="fas fa-lightbulb text-warning me-2"></i>Smart Recommendation</h6>
                            <p class="mb-2">For sending to <strong>${selectedCountry.flag} ${selectedCountry.name}</strong>:</p>
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong>${recommendedRoute.name}</strong>
                                    <br><small class="text-muted">${recommendedRoute.description}</small>
                                </div>
                                <div class="text-end">
                                    <h5 class="text-success mb-0">$${recommendedRoute.cost.toFixed(3)}</h5>
                                    <small class="text-success">Save 60%</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="cost-comparison">
                            <h6 class="text-center mb-3">Monthly Savings Estimate</h6>
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="border-end border-light">
                                        <h4>$${(directRoute.cost * 100).toFixed(2)}</h4>
                                        <small>Direct Route</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <h4>$${(recommendedRoute.cost * 100).toFixed(2)}</h4>
                                    <small>Recommended</small>
                                </div>
                            </div>
                            <hr class="border-light">
                            <div class="text-center">
                                <h5>Save $${((directRoute.cost - recommendedRoute.cost) * 100).toFixed(2)}/month</h5>
                                <small>Based on 100 SMS per month</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Load inbox badge
        async function loadInboxBadge() {
            try {
                const badge = document.getElementById('inboxBadge');
                badge.textContent = '3';
                badge.style.display = 'inline';
            } catch (error) {
                console.error('Error loading inbox badge:', error);
            }
        }

        // Show bulk send modal
        function showBulkSendModal() {
            alert('Bulk send feature coming soon!');
        }

        // Refresh rates
        function refreshRates() {
            alert('Exchange rates updated!');
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/login';
        }
    </script>
</body>
</html>