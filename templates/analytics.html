<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CumApp - Analytics Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/"><i class="fas fa-chart-line me-2"></i>CumApp Analytics</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/hub">Hub</a>
                <a class="nav-link" href="/docs">API</a>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <h1 class="mb-4">Platform Analytics</h1>
        
        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-paper-plane fa-2x text-primary mb-2"></i>
                        <h3 id="sms-stat">0</h3>
                        <p class="text-muted">SMS Sent</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-shield-alt fa-2x text-success mb-2"></i>
                        <h3 id="verify-stat">0</h3>
                        <p class="text-muted">Verifications</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-robot fa-2x text-info mb-2"></i>
                        <h3 id="ai-stat">0</h3>
                        <p class="text-muted">AI Analyses</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-chart-line fa-2x text-warning mb-2"></i>
                        <h3 id="api-stat">0</h3>
                        <p class="text-muted">API Calls</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Usage Overview</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="usageChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Recent Activity</h5>
                    </div>
                    <div class="card-body">
                        <div id="activity-list" style="max-height: 300px; overflow-y: auto;">
                            <div class="text-center text-muted">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let usageChart;

        async function loadAnalytics() {
            try {
                const response = await fetch('/api/analytics/stats');
                const stats = await response.json();
                
                // Update stats cards
                document.getElementById('sms-stat').textContent = stats.sms_sent || 0;
                document.getElementById('verify-stat').textContent = stats.verifications_created || 0;
                document.getElementById('ai-stat').textContent = stats.ai_analyses || 0;
                document.getElementById('api-stat').textContent = stats.api_calls || 0;
                
                // Update chart
                updateChart(stats);
                
                // Load recent activity
                loadRecentActivity();
                
            } catch (error) {
                console.error('Failed to load analytics:', error);
            }
        }

        function updateChart(stats) {
            const ctx = document.getElementById('usageChart').getContext('2d');
            
            if (usageChart) {
                usageChart.destroy();
            }
            
            usageChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['SMS Sent', 'Verifications', 'AI Analyses', 'API Calls'],
                    datasets: [{
                        data: [
                            stats.sms_sent || 0,
                            stats.verifications_created || 0,
                            stats.ai_analyses || 0,
                            stats.api_calls || 0
                        ],
                        backgroundColor: [
                            '#007bff',
                            '#28a745',
                            '#17a2b8',
                            '#ffc107'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        async function loadRecentActivity() {
            try {
                const response = await fetch('/api/analytics/events');
                const events = await response.json();
                
                const activityList = document.getElementById('activity-list');
                
                if (events.length === 0) {
                    activityList.innerHTML = '<div class="text-center text-muted">No recent activity</div>';
                    return;
                }
                
                activityList.innerHTML = events.slice(0, 10).map(event => `
                    <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                        <div>
                            <i class="fas fa-${getEventIcon(event.type)} me-2"></i>
                            <strong>${formatEventType(event.type)}</strong>
                        </div>
                        <small class="text-muted">${formatTime(event.timestamp)}</small>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Failed to load activity:', error);
            }
        }

        function getEventIcon(type) {
            const icons = {
                'sms_sent': 'paper-plane',
                'verification_created': 'shield-alt',
                'ai_analysis': 'robot',
                'api_call': 'code'
            };
            return icons[type] || 'circle';
        }

        function formatEventType(type) {
            return type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function formatTime(timestamp) {
            return new Date(timestamp).toLocaleTimeString();
        }

        // Load analytics on page load
        loadAnalytics();
        
        // Refresh every 30 seconds
        setInterval(loadAnalytics, 30000);
    </script>
</body>
</html>