services:
  # Main Web Service
  - type: web
    name: cumapp
    env: python
    region: oregon
    plan: starter
    buildCommand: |
      pip install --upgrade pip
      pip install -r requirements.txt
    startCommand: python scripts/start_production.py
    healthCheckPath: /health
    routes:
      # API routes should go to the web service
      - type: rewrite
        source: "/api/(.*)"
        destination: "/api/$1"
      # Health check and docs should go to web service  
      - type: rewrite
        source: "/health"
        destination: "/health"
      - type: rewrite
        source: "/docs"
        destination: "/docs"
      - type: rewrite
        source: "/redoc"
        destination: "/redoc"
      - type: rewrite
        source: "/openapi.json"
        destination: "/openapi.json"
      # Everything else goes to frontend
      - type: rewrite
        source: "/(.*)"
        destination: "http://frontend/$1"
    envVars:
      - key: PYTHON_VERSION
        value: 3.11.0
      - key: JWT_SECRET_KEY
        generateValue: true
      - key: JWT_ALGORITHM
        value: HS256
      - key: JWT_EXPIRE_MINUTES
        value: 30
      - key: DEBUG
        value: false
      - key: LOG_LEVEL
        value: INFO
      - key: USE_MOCK_TWILIO
        value: true
      - key: DATABASE_URL
        fromDatabase:
          name: cumapp-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: cumapp-redis
          property: connectionString

  # Frontend Service
  - type: static
    name: frontend
    region: oregon
    plan: starter
    buildCommand: |
      cd frontend && npm ci && npm run build
    staticPublishPath: frontend/build
    routes:
      - type: rewrite
        source: "/(.*)"
        destination: "/index.html"

  # PostgreSQL Database
  - type: pserv
    name: cumapp-db
    env: postgresql
    region: oregon
    plan: starter
    databaseName: cumapp
    user: cumapp

  # Redis Cache
  - type: redis
    name: cumapp-redis
    region: oregon
    plan: starter
    maxmemoryPolicy: allkeys-lru
